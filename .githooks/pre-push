#!/bin/bash
# Git pre-push hook for Salita
# Install: git config core.hooksPath .githooks

set -e

echo "üöÄ Running pre-push checks..."

# Build release binary
echo "üì¶ Building release binary..."
if ! cargo build --release 2>&1 | tail -20; then
    echo "‚ùå Release build failed"
    exit 1
fi

# Run all tests including integration tests
echo "üß™ Running all tests..."
if ! cargo test; then
    echo "‚ùå Tests failed"
    exit 1
fi

# Check if server is running for E2E tests
if curl -s http://localhost:6969/health > /dev/null 2>&1; then
    echo "üåê Running E2E tests..."
    if SALITA_TEST_SEED=1 cargo test --test e2e_dashboard -- --ignored 2>&1 | tail -30; then
        echo "‚úÖ E2E tests passed"
    else
        echo "‚ö†Ô∏è  E2E tests failed (not blocking push)"
    fi
else
    echo "‚ö†Ô∏è  Server not running - skipping E2E tests"
    echo "   Start server with: SALITA_TEST_SEED=1 cargo run"
fi

echo "‚úÖ Pre-push checks passed!"
